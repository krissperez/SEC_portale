{% extends 'base.html.twig' %}

{% block javascripts%}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.20/c3.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.20/c3.min.js"></script>
{% endblock %}

{% block body %}
    <div id="chart-pie">

    </div>
    <script>
        $(function (){
            const chart = {
                init: () => {
                    chart.getClientDistribution()

                },
                getClientDistribution: async () => {
                    try {
                        const response = await  chart.handleGetClientDistribution();
                        chart.createChartPie(response.data)
                    }catch (e){
                        alert(e)
                    }

                },
                handleGetClientDistribution: () => {
                  return new Promise((resolve, reject) => {
                      $.ajax({
                          url: 'api/analisi',
                          type: 'GET',
                          dataType: 'json',
                          success: function(data) {
                              resolve(data)
                          },
                          error: function(error) {

                              reject(error)

                          }
                      });
                  })
                },
                formatClientColumn: (arr) => {
                    const result = [];

                    for(const [key, values] of Object.entries(arr)){
                        const percent = parseFloat(values['percent']).toFixed(2)
                        const nameSurnameConcat = `${values['nome']} - ${values['cognome']}`
                        result.push([nameSurnameConcat, percent])
                    }

                    return result;
                },
                createChartPie: (dataClient) => {

                    c3.generate({
                        bindto: '#chart-pie',
                        data: {
                            columns: chart.formatClientColumn(dataClient),
                            type: 'pie'
                        },
                        pie: {
                            label: {
                                format: function (value, ratio, id) {
                                    return d3.format("")(value);
                                }
                            }
                        }
                    });
                }
            }

            chart.init();
        })
    </script>
{% endblock %}